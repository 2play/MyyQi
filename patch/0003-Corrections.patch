From 011043c1ae453283cb839b2a92cda8ce4d8b5d59 Mon Sep 17 00:00:00 2001
From: Myy <myy@miouyouyou.fr>
Date: Sat, 12 Nov 2016 22:04:47 +0000
Subject: [PATCH 3/4] Corrections...

---
 drivers/gpu/arm/midgard/mali_kbase_mem.c       | 6 ++++--
 drivers/gpu/arm/midgard/mali_kbase_mem_linux.c | 9 ++++++++-
 drivers/gpu/drm/rockchip/rockchip_drm_fbdev.c  | 2 ++
 drivers/gpu/drm/rockchip/rockchip_drm_gem.c    | 4 ++--
 drivers/gpu/drm/rockchip/rockchip_drm_gem.h    | 2 +-
 5 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/arm/midgard/mali_kbase_mem.c b/drivers/gpu/arm/midgard/mali_kbase_mem.c
index 60d31ac..8fd1e0a 100644
--- a/drivers/gpu/arm/midgard/mali_kbase_mem.c
+++ b/drivers/gpu/arm/midgard/mali_kbase_mem.c
@@ -2044,11 +2044,13 @@ static int kbase_jd_user_buf_map(struct kbase_context *kctx,
 			reg->flags & KBASE_REG_GPU_WR,
 			0, pages, NULL);
 #else
+  unsigned int flags = 0;
+  if (reg->flags & KBASE_REG_GPU_WR) flags |= FOLL_WRITE;
 	pinned_pages = get_user_pages_remote(NULL, mm,
 			address,
 			alloc->imported.user_buf.nr_pages,
-			reg->flags & KBASE_REG_GPU_WR,
-			0, pages, NULL);
+		  flags,
+		  pages, NULL);
 #endif
 
 	if (pinned_pages <= 0)
diff --git a/drivers/gpu/arm/midgard/mali_kbase_mem_linux.c b/drivers/gpu/arm/midgard/mali_kbase_mem_linux.c
index b6dac55..6ea3750 100644
--- a/drivers/gpu/arm/midgard/mali_kbase_mem_linux.c
+++ b/drivers/gpu/arm/midgard/mali_kbase_mem_linux.c
@@ -1121,6 +1121,7 @@ static struct kbase_va_region *kbase_mem_from_user_buffer(
 	long faulted_pages;
 	int zone = KBASE_REG_ZONE_CUSTOM_VA;
 	bool shared_zone = false;
+  unsigned int user_pages_flags = 0;
 
 	*va_pages = (PAGE_ALIGN(address + size) >> PAGE_SHIFT) -
 		PFN_DOWN(address);
@@ -1192,9 +1193,15 @@ static struct kbase_va_region *kbase_mem_from_user_buffer(
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 6, 0)
 	faulted_pages = get_user_pages(current, current->mm, address, *va_pages,
 			reg->flags & KBASE_REG_GPU_WR, 0, NULL, NULL);
-#else
+#elsif LINUX_VERSION_CODE < KERNEL_VERSION(4, 9, 0)
 	faulted_pages = get_user_pages(address, *va_pages,
 			reg->flags & KBASE_REG_GPU_WR, 0, NULL, NULL);
+#else
+
+  if (reg->flags & KBASE_REG_GPU_WR)
+    user_pages_flags |= FOLL_WRITE;
+  faulted_pages = get_user_pages(address, *va_pages,
+                                 user_pages_flags, NULL, NULL);
 #endif
 	up_read(&current->mm->mmap_sem);
 
diff --git a/drivers/gpu/drm/rockchip/rockchip_drm_fbdev.c b/drivers/gpu/drm/rockchip/rockchip_drm_fbdev.c
index c26b63c..247b41a 100644
--- a/drivers/gpu/drm/rockchip/rockchip_drm_fbdev.c
+++ b/drivers/gpu/drm/rockchip/rockchip_drm_fbdev.c
@@ -46,6 +46,8 @@ static struct dma_buf *rockchip_fbdev_get_dma_buf(struct fb_info *info) {
     if (buf)
       drm_gem_object_reference(private->fbdev_bo);
   }
+
+  return buf;
 }
 
 static struct fb_ops rockchip_drm_fbdev_ops = {
diff --git a/drivers/gpu/drm/rockchip/rockchip_drm_gem.c b/drivers/gpu/drm/rockchip/rockchip_drm_gem.c
index 69ff0bd..e233a5e 100644
--- a/drivers/gpu/drm/rockchip/rockchip_drm_gem.c
+++ b/drivers/gpu/drm/rockchip/rockchip_drm_gem.c
@@ -18,7 +18,7 @@
 #include <drm/drm_vma_manager.h>
 #include <drm/rockchip_drm.h>
 
-#include <linux/dma-attrs.h>
+#include <linux/dma-mapping.h>
 #include <linux/dma-buf.h>
 
 #include "rockchip_drm_drv.h"
@@ -121,7 +121,7 @@ rockchip_gem_prime_import_sg_table(struct drm_device *drm,
 
   obj = &rk_obj->base;
 
-  drm_gem_private_object_init(rm, obj, attach->dmabuf->size);
+  drm_gem_private_object_init(drm, obj, attach->dmabuf->size);
 
   rk_obj->dma_addr = sg_dma_address(sgt->sgl);
   rk_obj->sgt = sgt;
diff --git a/drivers/gpu/drm/rockchip/rockchip_drm_gem.h b/drivers/gpu/drm/rockchip/rockchip_drm_gem.h
index a8578a9..9e1692a 100644
--- a/drivers/gpu/drm/rockchip/rockchip_drm_gem.h
+++ b/drivers/gpu/drm/rockchip/rockchip_drm_gem.h
@@ -30,7 +30,7 @@ struct rockchip_gem_object {
 struct sg_table *rockchip_gem_prime_get_sg_table(struct drm_gem_object *obj);
 struct drm_gem_object *
 rockchip_gem_prime_import_sg_table(struct drm_device *dev,
-                                   struct dma_buf_attachement *attach,
+                                   struct dma_buf_attachment *attach,
                         				   struct sg_table *sgt);
 void *rockchip_gem_prime_vmap(struct drm_gem_object *obj);
 void rockchip_gem_prime_vunmap(struct drm_gem_object *obj, void *vaddr);
-- 
2.4.10

